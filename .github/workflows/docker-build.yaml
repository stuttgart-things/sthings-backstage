---
name: Docker Build & Push
on:
  push:
    branches:
      - main
      - feat/*
      - fix/*
  pull_request:
    branches:
      - main
      - feat/*
      - fix/*

jobs:
  docker-build:
    name: docker-build
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: yarn

      - name: Install dependencies
        run: yarn install --immutable

      - name: TypeScript compile
        run: yarn tsc

      - name: Build backend
        run: yarn build:backend

      - name: Set image name
        id: image-name
        run: |
          RANDOM_SUFFIX=$(openssl rand -hex 6)
          echo "name=sthings-backstage-${RANDOM_SUFFIX}" >> $GITHUB_OUTPUT

      - name: Dagger Build and Push
        id: build-image
        uses: dagger/dagger-for-github@v8.2.0
        with:
          module: github.com/stuttgart-things/dagger/docker
          call: >-
            build-and-push
            --source .
            --repository-name ""
            --registry-url ttl.sh/${{ steps.image-name.outputs.name }}
            --tag "${{ github.sha }}"
            --dockerfile packages/backend/Dockerfile
            --progress plain
          cloud-token: ${{ secrets.DAGGER_CLOUD_TOKEN }}

      - name: Scan image with Trivy
        uses: dagger/dagger-for-github@v8.2.0
        with:
          module: github.com/stuttgart-things/dagger/trivy
          call: scan-image --image-ref="ttl.sh/${{ steps.image-name.outputs.name }}:${{ github.sha }}" --severity="HIGH,CRITICAL" --trivy-version="0.64.1" export --path=/tmp/trivy-scan-report.json
          cloud-token: ${{ secrets.DAGGER_CLOUD_TOKEN }}

      - name: Upload scan report
        uses: actions/upload-artifact@v6
        with:
          name: trivy-scan-report
          path: /tmp/trivy-scan-report.json
          retention-days: 30

      - name: Check for vulnerabilities
        run: |
          if command -v jq &> /dev/null; then
            VULN_COUNT=$(jq '[.Results[]?.Vulnerabilities[]?] | length' /tmp/trivy-scan-report.json 2>/dev/null || echo "0")
            echo "Found $VULN_COUNT HIGH/CRITICAL vulnerabilities"

            if [ "$VULN_COUNT" -gt 0 ]; then
              echo "::warning::Image contains $VULN_COUNT HIGH/CRITICAL vulnerabilities"
              jq -r '.Results[]? | select(.Vulnerabilities) | "\(.Target): \(.Vulnerabilities | length) vulnerabilities"' \
                /tmp/trivy-scan-report.json
            else
              echo "âœ… No HIGH/CRITICAL vulnerabilities found!"
            fi
          fi

      - name: Build Summary
        run: |
          echo "## ðŸŽ‰ Container Image Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`ttl.sh/${{ steps.image-name.outputs.name }}:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pull command:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ttl.sh/${{ steps.image-name.outputs.name }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â° **Note:** ttl.sh images expire after 1 hour" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if command -v jq &> /dev/null; then
            VULN_COUNT=$(jq '[.Results[]?.Vulnerabilities[]?] | length' /tmp/trivy-scan-report.json 2>/dev/null || echo "0")
            if [ "$VULN_COUNT" -gt 0 ]; then
              echo "### âš ï¸ Security Scan Results" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Found **$VULN_COUNT HIGH/CRITICAL vulnerabilities**" >> $GITHUB_STEP_SUMMARY
            else
              echo "### âœ… Security Scan Results" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "No HIGH/CRITICAL vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
            fi
          fi
