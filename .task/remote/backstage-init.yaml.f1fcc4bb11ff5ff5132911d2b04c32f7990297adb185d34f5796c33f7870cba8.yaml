version: 3

vars:
  DEFAULT_BACKSTAGE_DIR:
    sh: pwd

tasks:
  install-yarn:
    desc: Install yarn globally via npm (only if missing)
    cmds:
      - |
        if command -v yarn >/dev/null 2>&1; then
          echo "✓ Yarn already installed: $(yarn --version)"
        else
          echo "Yarn not found. Installing yarn globally..."
          npm install --global yarn
          echo "✓ Yarn installed successfully: $(yarn --version)"
        fi

  init:
    desc: Install yarn + scaffold a new Backstage app into a chosen folder
    deps:
      - install-yarn
    cmds:
      - |
        echo "Where do you want to create the Backstage application?"
        echo "Default: {{ .DEFAULT_BACKSTAGE_DIR }}"
        echo ""

        TARGET_DIR=$(gum input \
          --placeholder "{{ .DEFAULT_BACKSTAGE_DIR }}")

        TARGET_DIR="$(echo "$TARGET_DIR" | xargs)"

        if [ -z "$TARGET_DIR" ]; then
          TARGET_DIR="{{ .DEFAULT_BACKSTAGE_DIR }}"
        fi

        echo ""
        echo "Creating Backstage app in: $TARGET_DIR"
        mkdir -p "$TARGET_DIR"
        cd "$TARGET_DIR"

        echo "Running in: $(pwd)"
        echo ""

        npx @backstage/create-app

      - |
        echo ""
        echo "✓ Backstage application scaffolded successfully"
